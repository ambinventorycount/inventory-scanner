<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta tags and title remain the same -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        /* Styles remain unchanged */
    </style>
</head>
<body>
    <!-- HTML structure remains the same -->

    <script>
        let currentScanField = '';
        let isScanning = false;
        let isInitialized = false; // Track if Quagga is initialized

        function startScanner(fieldId) {
            currentScanField = fieldId;
            if (!isScanning) {
                initializeScanner();
            }
        }

        function initializeScanner() {
            if (isInitialized) {
                // Already initialized, just start the scanner
                Quagga.start();
                isScanning = true;
                return;
            }

            isScanning = true;
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-viewport'),
                    constraints: {
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "upc_reader"]
                }
            }, (err) => {
                if (err) {
                    console.error(err);
                    showStatus(err.message, true);
                    isScanning = false;
                    return;
                }
                isInitialized = true;
                Quagga.start();
            });

            Quagga.onDetected((result) => {
                const code = result.codeResult.code;
                document.getElementById(currentScanField).value = code;
                stopScanner();
                showStatus('Barcode scanned successfully!');
            });
        }

        function stopScanner() {
            if (isScanning) {
                Quagga.stop();
                isScanning = false;
            }
        }

        async function saveToSheet() {
            const item = document.getElementById('itemBarcode').value;
            const serial = document.getElementById('serialBarcode').value;
            
            if (!item || !serial) {
                showStatus('Please fill both fields', true);
                return;
            }

            const scriptURL = 'https://script.google.com/macros/s/AKfycbyqA27Fo9cxdpdMuckQ2Z--GBuHryoeMyc5Wm7YOsZQ_QRQQ2a5Q9uDfEtrVmZ5hlyY/exec'; // Replace with your URL
            const data = {
                item: item,
                serial: serial,
                timestamp: new Date().toISOString()
            };

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const responseData = await response.json();
                if (responseData.result === 'success') {
                    showStatus('Data saved successfully!');
                    document.getElementById('itemBarcode').value = '';
                    document.getElementById('serialBarcode').value = '';
                } else {
                    showStatus('Error saving data: ' + responseData.message, true);
                }
            } catch (error) {
                showStatus('Network error: ' + error.message, true);
            }
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'error' : 'status';
            setTimeout(() => statusDiv.textContent = '', 3000);
        }
    </script>
</body>
</html>