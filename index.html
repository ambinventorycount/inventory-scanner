<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode Scanner with Camera Controls</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #reader { width: 100%; max-width: 400px; margin: auto; }
    input, button { display: block; width: 90%; margin: 10px auto; padding: 10px; }
    .controls { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Scan or Enter Barcodes</h2>
  <div id="reader"></div>
  
  <label>Item Barcode:</label>
  <input type="text" id="itemBarcode" placeholder="Scan or enter item barcode">
  
  <label>Serial Barcode:</label>
  <input type="text" id="serialBarcode" placeholder="Scan or enter serial barcode">
  
  <div class="controls">
    <button id="toggleTorch">Toggle Torch</button>
    <label for="focusRange">Adjust Focus:</label>
    <input type="range" id="focusRange" min="0" max="10" step="0.1" value="0">
  </div>

  <script>
    // On scan, fill the first empty barcode input
    function onScanSuccess(decodedText, decodedResult) {
      if (!document.getElementById("itemBarcode").value) {
        document.getElementById("itemBarcode").value = decodedText;
      } else {
        document.getElementById("serialBarcode").value = decodedText;
      }
    }

    const html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        html5QrCode.start(
          cameras[0].id,
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess
        );
      }
    }).catch(err => console.error(err));

    // Utility function to get the active video track
    function getVideoTrack() {
      const video = document.querySelector("video");
      if (video && video.srcObject) {
        const tracks = video.srcObject.getVideoTracks();
        return tracks.length ? tracks[0] : null;
      }
      return null;
    }

    // Torch (flash) toggle
    document.getElementById("toggleTorch").addEventListener("click", () => {
      const track = getVideoTrack();
      if (track) {
        const capabilities = track.getCapabilities();
        if (capabilities.torch) {
          const settings = track.getSettings();
          const currentTorch = settings.torch || false;
          track.applyConstraints({ advanced: [{ torch: !currentTorch }] })
          .catch(err => console.error("Torch toggle error:", err));
        } else {
          alert("Torch not supported on this device.");
        }
      }
    });

    // Focus adjustment
    document.getElementById("focusRange").addEventListener("input", (e) => {
      const track = getVideoTrack();
      if (track) {
        const capabilities = track.getCapabilities();
        if (capabilities.focusDistance) {
          track.applyConstraints({
            advanced: [{
              focusMode: "manual",
              focusDistance: parseFloat(e.target.value)
            }]
          }).catch(err => console.error("Focus adjustment error:", err));
        } else {
          console.log("Focus adjustment not supported.");
        }
      }
    });
  </script>
</body>
</html>
