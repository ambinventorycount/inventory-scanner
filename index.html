<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">
    <style>
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        #scanner-container { position: relative; margin: 20px 0; }
        #scanner-view { width: 100%; height: 300px; border: 2px solid #9b4dca; }
        .item-list { margin: 20px 0; border-top: 1px solid #eee; }
        .item { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <h3>Barcode Scanner</h3>
        
<div class="select-container">
    <label for="userSelect">Select User:</label>
    <select id="userSelect" required>
        <option value="" disabled selected>Choose user...</option>
        <option value="User1">User 1</option>
        <option value="User2">User 2</option>
        <option value="User3">User 3</option>
    </select>
</div>
        
        <!-- Scanner Section -->
        <div id="scanner-container">
            <video id="scanner-view"></video>
            <button id="toggle-scanner" class="button">Start Scanner</button>
        </div>

        <!-- Manual Input -->
        <div class="row">
            <div class="column">
                <input type="text" id="manualBarcode" placeholder="Enter barcode manually">
                <button onclick="addManualBarcode()" class="button">Add Manually</button>
            </div>
        </div>

        <!-- Scanned Items List -->
        <div class="item-list" id="itemsList"></div>

        <!-- Submit Button -->
        <button onclick="submitData()" class="button button-primary">Submit Data</button>
    </div>

    <!-- Include Barcode Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@latest/minified/html5-qrcode.min.js"></script>
    <script>
        let scannedItems = [];
        let scanner = null;
        const scannerView = document.getElementById('scanner-view');
        const toggleScannerBtn = document.getElementById('toggle-scanner');

        // Initialize Scanner
        function initScanner() {
            scanner = new Html5QrcodeScanner('scanner-view', {
                fps: 10,
                qrbox: 250
            });

            scanner.render(onScanSuccess, onScanError);
        }

        // Scan Success Handler
        function onScanSuccess(barcode) {
            addScannedItem(barcode);
            scanner.clear();
            toggleScannerBtn.textContent = 'Start Scanner';
        }

        // Scan Error Handler
        function onScanError(error) {
            console.error(error);
        }

        // Toggle Scanner
        toggleScannerBtn.addEventListener('click', () => {
            if (!scanner) {
                initScanner();
                toggleScannerBtn.textContent = 'Stop Scanner';
            } else {
                scanner.clear();
                scanner = null;
                toggleScannerBtn.textContent = 'Start Scanner';
            }
        });

        // Add Scanned Item
        function addScannedItem(barcode, quantity = 1) {
            scannedItems.push({
                barcode: barcode,
                quantity: quantity,
                timestamp: new Date().toISOString()
            });
            updateItemsList();
        }

        // Add Manual Barcode
        function addManualBarcode() {
            const manualBarcode = document.getElementById('manualBarcode').value;
            if (manualBarcode) {
                addScannedItem(manualBarcode);
                document.getElementById('manualBarcode').value = '';
            }
        }

        // Update Items List Display
        function updateItemsList() {
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = scannedItems.map((item, index) => `
                <div class="item">
                    Barcode: ${item.barcode}<br>
                    Quantity: <input type="number" value="${item.quantity}" 
                              onchange="updateQuantity(${index}, this.value)">
                    <button onclick="removeItem(${index})" class="button button-small">Remove</button>
                </div>
            `).join('');
        }

        // Update Item Quantity
        function updateQuantity(index, newQuantity) {
            scannedItems[index].quantity = parseInt(newQuantity) || 1;
        }

        // Remove Item
        function removeItem(index) {
            scannedItems.splice(index, 1);
            updateItemsList();
        }

        // Submit Data to Google Sheets
        async function submitData() {
            const user = document.getElementById('userSelect').value;
            if (!user) {
                alert('Please select a user');
                return;
            }

            if (scannedItems.length === 0) {
                alert('No items to submit');
                return;
            }

            const payload = {
                user: user,
                items: scannedItems
            };

            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwCmATH_46227sPk_hqi_OTEzMN7PcsnZ9DRC9fo3Fkbi_QsEslq4egtjES9XTs_r24/exec', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('Data submitted successfully!');
                    scannedItems = [];
                    updateItemsList();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Submission failed');
            }
        }
    </script>
</body>
</html>