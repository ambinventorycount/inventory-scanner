<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner with Zoom</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .zoom-controls {
            margin-top: 1rem;
            background: rgba(0,0,0,0.7);
            padding: 1rem;
            border-radius: 8px;
            display: none;
        }
        .zoom-slider {
            width: 100%;
            height: 10px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .zoom-slider:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="container mt-4">
    <h2 class="mb-4">Barcode Scanner</h2>
    
    <div class="alert alert-info" role="alert" id="statusMessage">
        Ready to scan - Select a barcode type to begin
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <button class="btn btn-primary w-100" onclick="startScanner('item')" id="scanItemBtn">
                Scan Item Barcode
            </button>
        </div>
        <div class="col-md-6">
            <button class="btn btn-primary w-100" onclick="startScanner('serial')" id="scanSerialBtn">
                Scan Serial Barcode
            </button>
        </div>
    </div>

    <div class="mb-4">
        <input type="text" id="item" class="form-control mb-3" placeholder="Item Barcode" readonly>
        <input type="text" id="serial" class="form-control" placeholder="Serial Barcode" readonly>
    </div>

    <div class="d-grid gap-2 d-md-block mb-4">
        <button class="btn btn-outline-secondary me-2" onclick="toggleManualEntry()" id="manualEntryBtn">
            Toggle Manual Entry
        </button>
        <button class="btn btn-success" onclick="saveToGoogleSheets()" id="saveBtn">
            Save Record
        </button>
    </div>

    <div id="scanner-container" style="display: none;">
        <div id="qr-reader" style="width: 100%;"></div>
        <div class="zoom-controls" id="zoomControls">
            <label class="form-label text-white">Zoom: <span id="zoomValue">1x</span></label>
            <input type="range" class="zoom-slider" id="zoomRange" min="1" max="4" step="0.1" value="1">
        </div>
        <div class="text-center mt-3">
            <button class="btn btn-danger" onclick="stopScanner()">
                Stop Scanner
            </button>
        </div>
    </div>

    <script>
        let html5QrCode = null;
        let currentScannerType = '';
        let videoTrack = null;

        async function startScanner(type) {
            currentScannerType = type;
            const scannerContainer = document.getElementById('scanner-container');
            const zoomControls = document.getElementById('zoomControls');
            scannerContainer.style.display = 'block';
            document.getElementById('statusMessage').textContent = `Scanning ${type} barcode...`;
            
            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                
                const config = { 
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
                };

                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    qrCodeSuccessCallback,
                    qrCodeErrorCallback
                );

                // Get video track for zoom control
                const videoElement = document.querySelector('#qr-reader video');
                if (videoElement && videoElement.srcObject) {
                    videoTrack = videoElement.srcObject.getVideoTracks()[0];
                    setupZoomControls();
                }
            } catch (err) {
                console.error('Scanner error:', err);
                alert('Error starting scanner: ' + err);
                stopScanner();
            }
        }

        function setupZoomControls() {
            const zoomRange = document.getElementById('zoomRange');
            const zoomValue = document.getElementById('zoomValue');
            const zoomControls = document.getElementById('zoomControls');

            if (!videoTrack) {
                zoomControls.style.display = 'none';
                return;
            }

            const capabilities = videoTrack.getCapabilities();
            if (!capabilities.zoom) {
                zoomControls.style.display = 'none';
                return;
            }

            // Set up zoom range
            zoomRange.min = capabilities.zoom.min || 1;
            zoomRange.max = capabilities.zoom.max || 4;
            zoomRange.step = capabilities.zoom.step || 0.1;
            zoomRange.value = videoTrack.getSettings().zoom || 1;

            zoomValue.textContent = `${zoomRange.value}x`;
            zoomControls.style.display = 'block';

            // Add event listener for zoom changes
            zoomRange.addEventListener('input', async (e) => {
                try {
                    await videoTrack.applyConstraints({
                        advanced: [{ zoom: parseFloat(e.target.value) }]
                    });
                    zoomValue.textContent = `${e.target.value}x`;
                } catch (err) {
                    console.error('Error applying zoom:', err);
                }
            });
        }

        function qrCodeSuccessCallback(decodedText) {
            document.getElementById(currentScannerType).value = decodedText;
            stopScanner();
            updateStatusMessage();
        }

        function qrCodeErrorCallback(error) {
            // Optional: Handle scan errors
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode = null;
                    videoTrack = null;
                    document.getElementById('scanner-container').style.display = 'none';
                    document.getElementById('zoomControls').style.display = 'none';
                    updateStatusMessage();
                }).catch(err => {
                    console.error('Error stopping scanner:', err);
                });
            }
        }

        // Rest of the functions remain the same as previous version
        function updateStatusMessage() {
            const item = document.getElementById('item').value;
            const serial = document.getElementById('serial').value;
            let status = 'Ready to scan';
            
            if (!item && !serial) {
                status = 'Scan item barcode to begin';
            } else if (item && !serial) {
                status = 'Item scanned - ready to scan serial';
            } else if (item && serial) {
                status = 'Ready to save record';
            }
            
            document.getElementById('statusMessage').textContent = status;
        }

        function toggleManualEntry() {
            const inputs = document.querySelectorAll('input');
            const isDisabled = inputs[0].hasAttribute('readonly');
            
            inputs.forEach(input => {
                if (isDisabled) {
                    input.removeAttribute('readonly');
                } else {
                    input.setAttribute('readonly', true);
                }
            });
            
            document.getElementById('manualEntryBtn').textContent = 
                `${isDisabled ? 'Disable' : 'Enable'} Manual Entry`;
        }

        async function saveToGoogleSheets() {
            const item = document.getElementById('item').value;
            const serial = document.getElementById('serial').value;
            const saveBtn = document.getElementById('saveBtn');
            
            if (!item || !serial) {
                alert('Please fill in both barcode fields.');
                return;
            }

            saveBtn.innerHTML = `Saving...`;
            saveBtn.disabled = true;

            const scriptURL = 'https://script.google.com/macros/s/AKfycbwXB6XxWn0GVMSEXr6PlTrwXFMGG29RCwBm0sjAkTa4/dev';
            
            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        item, 
                        serial,
                        timestamp: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    document.getElementById('item').value = '';
                    document.getElementById('serial').value = '';
                    alert('Data saved successfully!');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Save failed. Please check console for details.');
            } finally {
                saveBtn.innerHTML = `Save Record`;
                saveBtn.disabled = false;
                updateStatusMessage();
            }
        }
    </script>
</body>
</html>