<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ZXing-js Library as fallback -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body class="container mt-4">
    <h2 class="mb-4">Barcode Scanner</h2>
    
    <!-- Scan Buttons -->
    <div class="btn-group mb-3">
        <button class="btn btn-primary" onclick="startScanner('item')">Scan Item Barcode</button>
        <button class="btn btn-primary" onclick="startScanner('serial')">Scan Serial Barcode</button>
    </div>

    <!-- Input Fields -->
    <div class="mb-3">
        <input type="text" id="item" class="form-control mb-2" placeholder="Item Barcode" required>
        <input type="text" id="serial" class="form-control" placeholder="Serial Barcode" required>
    </div>

    <!-- Controls -->
    <div class="btn-group mb-4">
        <button id="manualToggle" class="btn btn-secondary" onclick="toggleManualEntry()">Enable Manual Entry</button>
        <button class="btn btn-success" onclick="saveToGoogleSheets()">Save Record</button>
    </div>

    <!-- Scanner Preview -->
    <div id="scanner-container" class="d-none">
        <video id="scanner-video" style="width: 100%; height: 300px;"></video>
        <button class="btn btn-danger mt-2" onclick="stopScanner()">Stop Scanner</button>
    </div>

    <!-- Status Alert -->
    <div id="alert" class="alert d-none" role="alert"></div>

    <script>
        let currentScannerType = '';
        let manualEntryEnabled = false;
        let codeReader = null;
        let mediaStream = null;

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.classList.remove('d-none');
            setTimeout(() => alert.classList.add('d-none'), 3000);
        }

        async function startScanner(type) {
            currentScannerType = type;
            const videoElement = document.getElementById('scanner-video');
            
            try {
                document.getElementById('scanner-container').classList.remove('d-none');
                
                if ('BarcodeDetector' in window) {
                    // Use native HTML5 Barcode Detection API
                    const formats = ['code_128', 'code_39', 'upc_a'];
                    const barcodeDetector = new BarcodeDetector({ formats });
                    
                    mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" }
                    });
                    
                    videoElement.srcObject = mediaStream;
                    videoElement.play();
                    
                    const detectBarcode = () => {
                        barcodeDetector.detect(videoElement)
                            .then(barcodes => {
                                if (barcodes.length > 0) {
                                    document.getElementById(currentScannerType).value = barcodes[0].rawValue;
                                    stopScanner();
                                } else {
                                    requestAnimationFrame(detectBarcode);
                                }
                            })
                            .catch(console.error);
                    };
                    
                    detectBarcode();
                } else {
                    // Fallback to ZXing-js
                    codeReader = new ZXing.BrowserMultiFormatReader();
                    await codeReader.decodeFromVideoDevice(
                        undefined,
                        'scanner-video',
                        (result, error) => {
                            if (result) {
                                document.getElementById(currentScannerType).value = result.text;
                                stopScanner();
                            }
                            if (error) console.error(error);
                        }
                    );
                }
            } catch (err) {
                showAlert(`Scanner error: ${err.message}`, 'danger');
                stopScanner();
            }
        }

        async function stopScanner() {
            const videoElement = document.getElementById('scanner-video');
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (codeReader) {
                await codeReader.reset();
                codeReader = null;
            }
            videoElement.srcObject = null;
            document.getElementById('scanner-container').classList.add('d-none');
        }

        function toggleManualEntry() {
            manualEntryEnabled = !manualEntryEnabled;
            const inputs = document.querySelectorAll('input');
            const toggleBtn = document.getElementById('manualToggle');
            
            inputs.forEach(input => input.disabled = !manualEntryEnabled);
            toggleBtn.textContent = manualEntryEnabled ? 'Disable Manual Entry' : 'Enable Manual Entry';
            toggleBtn.classList.toggle('btn-secondary');
            toggleBtn.classList.toggle('btn-warning');
        }

        async function saveToGoogleSheets() {
            const item = document.getElementById('item').value;
            const serial = document.getElementById('serial').value;

            if (!item || !serial) {
                showAlert('Please fill both fields!', 'warning');
                return;
            }

            const scriptURL = 'YOUR_GOOGLE_SCRIPT_URL_HERE';
            
            try {
                await fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify({
                        item: item,
                        serial: serial,
                        timestamp: new Date().toISOString()
                    })
                });

                showAlert('Data saved successfully!');
                document.getElementById('item').value = '';
                document.getElementById('serial').value = '';
            } catch (error) {
                showAlert('Error saving data. Please try again.', 'danger');
                console.error('Error:', error);
            }
        }

        window.addEventListener('beforeunload', stopScanner);
    </script>
</body>
</html>