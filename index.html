<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    /* ... (keep your existing styles the same) ... */
  </style>
</head>
<body>
  <h2>Scan Item & Serial Barcodes 5.2 18</h2>
  <div class="controls">
    <br>
    <label for="zoomRange">Adjust Zoom:</label>
    <input type="range" id="zoomRange" min="1" max="20" step="0.1" value="5">
  </div>

  <div id="reader"></div>
  <input type="text" id="itemBarcode" placeholder="Item Barcode">
  <input type="text" id="serialBarcode" placeholder="Serial Barcode">
  
  <button onclick="startScanner()">Start Scanner</button>
  <button onclick="stopScanner()">Stop Scanner</button>
  <button onclick="saveToGoogleSheets()">Save Record</button>

  <script>
    let scanner;
    let scanningItem = true;

    async function startScanner() {
      scanner = new Html5Qrcode("reader");
      
      const config = {
        fps: 30,
        qrbox: { width: 250, height: 250 },
        videoConstraints: {
          facingMode: 'environment',
          focusMode: 'continuous',
        }
      };

      try {
        await scanner.start(
          { facingMode: "environment" },
          config,
          (decodedText) => {
            if (scanningItem) {
              document.getElementById("itemBarcode").value = decodedText;
              scanningItem = false;
            } else {
              document.getElementById("serialBarcode").value = decodedText;
              stopScanner();
              scanningItem = true;
            }
          }
        );
        console.log("Scanner started");
        setupZoomControl();
      } catch (err) {
        console.error("Scanner start failed:", err);
      }
    }

    function stopScanner() {
      if (scanner) {
        scanner.stop().then(() => {
          console.log("Scanner stopped");
        }).catch(console.error);
      }
    }

    function setupZoomControl() {
      const zoomRange = document.getElementById("zoomRange");
      zoomRange.addEventListener("input", (e) => {
        const video = document.querySelector("#reader video");
        if (!video) return;
        
        const track = video.srcObject.getVideoTracks()[0];
        if (track && typeof track.getCapabilities === 'function') {
          const capabilities = track.getCapabilities();
          if (capabilities.zoom) {
            const zoom = parseFloat(e.target.value);
            track.applyConstraints({ advanced: [{ zoom }] })
              .catch(err => console.error("Zoom error:", err));
          }
        }
      });
    }

    async function saveToGoogleSheets() {
      const item = document.getElementById("itemBarcode").value;
      const serial = document.getElementById("serialBarcode").value;
      
      if (!item || !serial) {
        alert("Please scan both barcodes!");
        return;
      }

      const scriptURL = 'https://script.google.com/macros/s/AKfycbyhMRU0DcDquqbamt5vSRBheJDIzEFcGnwgVZJ7H7fH4DbjJgFllr59xXjAWVElzpqKPg/exec';
      
      try {
        await fetch(scriptURL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ item, serial, timestamp: new Date().toISOString() })
        });
        alert('Data saved!');
        document.getElementById('serialBarcode').value = '';
      } catch (error) {
        console.error('Error:', error);
        alert('Save failed. Check console.');
      }
    }
  </script>
</body>
</html>