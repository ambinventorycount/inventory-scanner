<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Inventory Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Arial; margin: 0; padding: 15px; }
        #reader { width: 100%; height: 60vh; border: 2px solid #ddd; }
        .input-group { margin: 15px 0; }
        input, button { width: 100%; padding: 12px; margin: 5px 0; }
        button { background: #4285f4; color: white; border: none; }
    </style>
</head>
<body>
    <div id="reader"></div>
    
    <div class="input-group">
        <input type="number" id="quantity" value="1" min="1">
    </div>
    
    <div class="input-group">
        <input type="text" id="username" placeholder="Your Name" required>
    </div>

    <button onclick="toggleScanner()">Start Scanning</button>

    <script>
        const APP_URL = "https://script.google.com/macros/s/AKfycbxgURydXrDbAvsHHFQ37UtfHX5z_8jt_bX41hEjakRLfkePMsAylHItW189HUmegF4/exec";
        const SECRET_KEY = "amb2025";
        let scanner = null;

        function toggleScanner() {
            if (!scanner) {
                startScanner();
            } else {
                stopScanner();
            }
        }

        function startScanner() {
            scanner = new Html5QrcodeScanner('reader', {
                qrbox: 250,
                fps: 5,
                formats: ['upc_a', 'ean_13', 'code_128']
            });

            scanner.render(async (barcode) => {
                await logScan(barcode);
                scanner.clear();
                scanner = null;
            });

            document.querySelector('button').textContent = "Stop Scanning";
        }

        function stopScanner() {
            if (scanner) {
                scanner.clear();
                scanner = null;
            }
            document.querySelector('button').textContent = "Start Scanning";
        }

        async function logScan(barcode) {
            const payload = {
                secret: SECRET_KEY,
                barcode: barcode,
                quantity: document.getElementById('quantity').value,
                user: document.getElementById('username').value,
                location: navigator.geolocation ? await getLocation() : ""
            };

            try {
                const response = await fetch(APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    alert('Scan logged successfully!');
                    document.getElementById('quantity').value = 1;
                } else {
                    alert('Error: ' + (await response.text()));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        function getLocation() {
            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    pos => resolve(`${pos.coords.latitude},${pos.coords.longitude}`),
                    () => resolve("")
                );
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* Add to existing styles */
        #batch-list { 
            margin: 10px 0;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
        }
        .batch-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .batch-actions { margin-top: 10px; }
    </style>
</head>
<body>
    <!-- Add after existing elements -->
    <div id="batch-list"></div>
    <div class="batch-actions">
        <button onclick="submitBatch()" style="background: #28a745;">Save Batch (0)</button>
        <button onclick="clearBatch()" style="background: #dc3545;">Clear Batch</button>
    </div>

    <script>
        let currentBatch = [];
        let scanner = null;

        // Modified scanner render function
        function startScanner() {
            scanner = new Html5QrcodeScanner('reader', {
                qrbox: 250,
                fps: 5,
                formats: ['upc_a', 'ean_13', 'code_128']
            });

            scanner.render(async (barcode) => {
                addToBatch(barcode);
                // Keep scanner active for next scan
                document.getElementById('reader').scrollIntoView();
            });

            document.querySelector('button').textContent = "Stop Scanning";
        }

        function addToBatch(barcode) {
            const existing = currentBatch.find(item => item.barcode === barcode);
            
            if (existing) {
                existing.quantity++;
            } else {
                currentBatch.push({
                    barcode,
                    quantity: 1,
                    timestamp: new Date().toISOString()
                });
            }

            updateBatchDisplay();
        }

        function updateBatchDisplay() {
            const list = document.getElementById('batch-list');
            const saveBtn = document.querySelector('.batch-actions button');
            
            // Update save button count
            saveBtn.textContent = `Save Batch (${currentBatch.length})`;
            
            // Clear existing list
            list.innerHTML = '';
            
            // Add new items
            currentBatch.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'batch-item';
                div.innerHTML = `
                    <div>
                        ${item.barcode} 
                        <small>(x${item.quantity})</small>
                    </div>
                    <div>
                        <button onclick="adjustQuantity(${index}, 1)">+</button>
                        <button onclick="adjustQuantity(${index}, -1)">-</button>
                        <button onclick="removeItem(${index})">Ã—</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function adjustQuantity(index, delta) {
            const newQuantity = currentBatch[index].quantity + delta;
            if (newQuantity > 0) {
                currentBatch[index].quantity = newQuantity;
                updateBatchDisplay();
            }
        }

        function removeItem(index) {
            currentBatch.splice(index, 1);
            updateBatchDisplay();
        }

        async function submitBatch() {
            if (currentBatch.length === 0) return;

            const user = document.getElementById('username').value;
            if (!user) {
                alert('Please enter your name');
                return;
            }

            const payload = {
                secret: SECRET_KEY,
                user: user,
                batch: currentBatch
            };

            try {
                const response = await fetch(APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(`Saved ${result.processed} items!`);
                    clearBatch();
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                alert('Submission failed: ' + error.message);
            }
        }

        function clearBatch() {
            currentBatch = [];
            updateBatchDisplay();
        }
    </script>
</body>
</html>