<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
/* Improved scanner visualization */
#scanner-container {
    position: fixed;
    top: 15%;
    left: 5%;
    width: 90%;
    height: 60vh;
    background: rgba(0,0,0,0.9);
    z-index: 1000;
    display: none;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0,255,0,0.3);
}

#scanner {
    width: 100%;
    height: 100%;
    position: relative;
}

#scanner video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#scanner canvas {
    position: absolute;
    top: 0;
    left: 0;
}
</style>
</head>
<body class="container mt-4">
    <h2 class="mb-4">Barcode Scanner</h2>
    
    <!-- Scan Buttons -->
    <button class="btn btn-primary mb-4" onclick="startScanner('item')">Scan Item Barcode</button>
    <button class="btn btn-primary mb-4" onclick="startScanner('serial')">Scan Serial Barcode</button>

    <!-- Input Fields -->
    <div class="mb-4">
        <input type="text" id="item" class="form-control mb-2" placeholder="Item Barcode">
        <input type="text" id="serial" class="form-control mb-2" placeholder="Serial Barcode">
    </div>

    <!-- Manual Entry Toggle -->
    <button class="btn btn-secondary mb-4" onclick="toggleManualEntry()">Manual Entry</button>
    
    <!-- Save Button -->
    <button class="btn btn-success mb-4" onclick="saveToGoogleSheets()">Save Record</button>

    <!-- Scanner Preview -->
    <div id="scanner-container" style="display: none;">
        <div id="scanner" style="width: 100%; height: 1px;"></div>
        <button class="btn btn-danger mt-3" onclick="stopScanner()">Stop Scanner</button>
    </div>

<script>
let currentScannerType = '';
let scannerActive = false;

function startScanner(type) {
    if (scannerActive) return;
    scannerActive = true;
    currentScannerType = type;
    document.getElementById('scanner-container').style.display = 'block';

    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#scanner'),
            constraints: {
                facingMode: "environment",
                width: { min: 1280, ideal: 1920 },
                height: { min: 720, ideal: 1080 },
                aspectRatio: { ideal: 1.7777778 } // 16:9
            }
        },
        decoder: {
            readers: [
                'code_128_reader',
                'ean_reader',
                'ean_8_reader',
                'code_39_reader',
                'upc_reader',
                'upc_e_reader'
            ],
            debug: {
                drawBoundingBox: true,
                showFrequency: true,
                drawScanline: true,
                showPattern: true
            },
            multipleScanlines: true,
            locate: true,
            halfSample: true,
            patches: [ "top", "bottom" ],
            frequency: 10 // Higher scan frequency
        },
        locator: {
            halfSample: true,
            patchSize: "medium", // large, medium, small
            debug: {
                showCanvas: true,
                showPatches: false,
                showFoundPatches: false,
                showSkeleton: false
            }
        },
        numOfWorkers: navigator.hardwareConcurrency || 4,
        frequency: 10,
        debug: false
    }, function(err) {
        if (err) {
            console.error("Scanner initialization error:", err);
            alert("Scanner error: " + err.message);
            scannerActive = false;
            return;
        }
        Quagga.start();
        requestAnimationFrame(keepScannerActive);
    });

    Quagga.onProcessed(function(result) {
        if (!result) return;
        
        const ctx = Quagga.canvas.ctx.overlay;
        const canvas = Quagga.canvas.dom.overlay;
        
        if (result.boxes) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            result.boxes.filter(box => box !== result.box).forEach(box => {
                Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, ctx, { color: "green", lineWidth: 2 });
            });
        }

        if (result.box) {
            Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, ctx, { color: "blue", lineWidth: 2 });
        }
    });

    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        const format = result.codeResult.format;
        if (isValidBarcode(code, format)) {
            document.getElementById(currentScannerType).value = code;
            stopScanner();
        }
    });
}

// Add validation for detected barcodes
function isValidBarcode(code, format) {
    const currentField = document.getElementById(currentScannerType);
    const expectedType = currentScannerType === 'item' ? ['ean', 'upc'] : ['code128', 'code39'];
    
    return expectedType.some(t => format.toLowerCase().includes(t)) && 
           code.length >= 6 && 
           code.length <= 20;
}

// Keep scanner active when tab is hidden
function keepScannerActive() {
    if (scannerActive) {
        Quagga.stop();
        Quagga.start();
        requestAnimationFrame(keepScannerActive);
    }
}

// Improved scanner stop function
function stopScanner() {
    scannerActive = false;
    Quagga.stop();
    document.getElementById('scanner-container').style.display = 'none';
    Quagga.offProcessed();
    Quagga.offDetected();
}

        function toggleManualEntry() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => input.disabled = !input.disabled);
        }

        async function saveToGoogleSheets() {
            const item = document.getElementById('item').value;
            const serial = document.getElementById('serial').value;
            
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyhMRU0DcDquqbamt5vSRBheJDIzEFcGnwgVZJ7H7fH4DbjJgFllr59xXjAWVElzpqKPg/exec';
            
            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item: item,
                        serial: serial,
                        timestamp: new Date().toISOString()
                    })
                });
                
                alert('Data saved successfully!');
                document.getElementById('item').value = '';
                document.getElementById('serial').value = '';
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving data');
            }
        }


function setFocus(value) {
    const stream = Quagga.CameraAccess.getActiveTrack();
    if (stream && stream.getCapabilities().focusDistance) {
        stream.applyConstraints({
            advanced: [{focusDistance: value}]
        });
    }
}
    </script>

<button class="btn btn-warning" onclick="toggleTorch()">Toggle Flashlight</button>

<script>
async function toggleTorch() {
    const stream = Quagga.CameraAccess.getActiveTrack();
    if (stream && stream.getCapabilities().torch) {
        await stream.applyConstraints({
            advanced: [{torch: !stream.getSettings().torch}]
        });
    }
}
</script>
</body>
</html>